<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anleitung: Daily Email Report</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.45; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1, h2, h3 { line-height: 1.2; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { padding: 12px; border: 1px solid rgba(127,127,127,.35); border-radius: 10px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0 18px; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid rgba(127,127,127,.25); vertical-align: top; }
    .note { padding: 10px 12px; border: 1px solid rgba(127,127,127,.35); border-radius: 10px; background: rgba(127,127,127,.08); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(127,127,127,.35); font-size: 12px; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
    .small { font-size: 0.92rem; opacity: 0.9; }
    .toc ul { margin: 8px 0 0 18px; }
  </style>
</head>

<body>
  <h1>Anleitung: Daily Email Report (IMAP + Ollama)</h1>
  <p class="small">
    Dieses Verzeichnis enthält ein kleines Programm, das E-Mails aus einem Zeitraum (heute bis N Tage in die Vergangenheit) aus einer IMAP-Mailbox lädt,
    per Ollama/LLM zusammenfassen lässt, nach Priorität sortiert und den Report als HTML-Mail versendet.
  </p>

  <div class="note toc">
    <b>Inhalt</b>
    <ul>
      <li><a href="#schnellstart">Schnellstart</a></li>
      <li><a href="#was-macht-es">Was macht das Programm?</a></li>
      <li><a href="#dateien">Welche Datei ist wofür?</a></li>
      <li><a href="#voraussetzungen">Voraussetzungen</a></li>
      <li><a href="#konfiguration">Konfiguration</a></li>
      <li><a href="#ausgabe">Ausgabe und Dateien</a></li>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
      <li><a href="#sicherheit">Sicherheit und Datenschutz</a></li>
    </ul>
  </div>

  <h2 id="schnellstart">Schnellstart</h2>
  <ol>
    <li><b>Ollama installieren</b> und starten (Download: <a href="https://ollama.com/download">ollama.com/download</a>). Sorge dafür, dass ein Modell vorhanden ist (z.B. <code>qwen2.5:7b-instruct-q8_0</code>).</li>
    <li><b>Python 3</b> muss verfügbar sein.</li>
    <li>Im Verzeichnis (Terminal öffnen) einmalig das Setup ausführen:</li>
  </ol>

  <h3>Linux / macOS (Terminal)</h3>
  <pre><code>chmod +x bootstrap.sh run.sh
./bootstrap.sh</code></pre>
  <p>Danach starten:</p>
  <pre><code>./run.sh</code></pre>

  <h3>Windows (PowerShell)</h3>
  <pre><code>.\bootstrap.ps1</code></pre>
  <p>Danach starten:</p>
  <pre><code>.\run.ps1</code></pre>
  <p class="small">
    Falls die Ausführung von Skripten blockiert ist, einmalig erlauben:
    <code>Set-ExecutionPolicy -Scope CurrentUser RemoteSigned</code>
  </p>

  <p class="note">
    <span class="pill">Tipp</span>
    Falls Ollama nicht unter <code>http://localhost:11434</code> läuft, setze <code>OLLAMA_URL</code> in <code>.env</code> (siehe <a href="#konfiguration">Konfiguration</a>).
  </p>

  <h2 id="was-macht-es">Was macht das Programm?</h2>
  <ul>
    <li>Lädt E-Mails aus einem Zeitraum: heute bis N Tage in die Vergangenheit (inklusive) aus einer IMAP-Mailbox.</li>
    <li>Extrahiert aus jeder Mail einen möglichst brauchbaren Text (Plain/HTML), fokussiert auf den neuesten Inhalt und trimmt Zitate.</li>
    <li>Schickt jede Mail zusammen mit einem Prompt an Ollama. Der Prompt definiert Ausgabeformat, Priorität (1 bis 5) und maximal zwei konkrete Aktionen.</li>
    <li>Sortiert die Ergebnisse nach Priorität.</li>
    <li>Erstellt eine HTML-Mail (Kartenansicht) plus Text-Alternative und sendet den Report per SMTP an die Zieladresse.</li>
  </ul>

  <h2 id="dateien">Welche Datei ist wofür?</h2>
  <table>
    <thead>
      <tr><th>Datei</th><th>Rolle</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><a href="./anleitung.html">anleitung.html</a></td>
        <td>Diese Anleitung.</td>
      </tr>
      <tr>
        <td><a href="./bootstrap.sh">bootstrap.sh</a></td>
        <td>Setup (Linux/macOS): Erstellt <code>.venv</code>, installiert Abhängigkeiten, legt <code>.env</code> an.</td>
      </tr>
      <tr>
        <td><a href="./bootstrap.ps1">bootstrap.ps1</a></td>
        <td>Setup (Windows PowerShell): Entspricht <code>bootstrap.sh</code>.</td>
      </tr>
      <tr>
        <td><a href="./run.sh">run.sh</a></td>
        <td>Start-Skript (Linux/macOS): lädt <code>.env</code>, aktiviert <code>.venv</code>, prüft Ollama, führt Python-Skript aus.</td>
      </tr>
      <tr>
        <td><a href="./run.ps1">run.ps1</a></td>
        <td>Start-Skript (Windows PowerShell): Entspricht <code>run.sh</code>.</td>
      </tr>
      <tr>
        <td><a href="./email_report.py">email_report.py</a></td>
        <td>Hauptprogramm: IMAP-Abruf (Zeitraum), LLM-Aufruf, Sortierung, HTML-Erstellung, SMTP-Versand.</td>
      </tr>
      <tr>
        <td><a href="./prompt.txt">prompt.txt</a></td>
        <td>Prompt-Template für das LLM. Definiert Regeln und Ausgabeformat (Deutsch, kurz, feste Labels).</td>
      </tr>
      <tr>
        <td><a href="./requirements.txt">requirements.txt</a></td>
        <td>Python-Abhängigkeiten (requests, BeautifulSoup, lxml, optional tqdm).</td>
      </tr>
      <tr>
        <td><code>.env</code> (wird erzeugt)</td>
        <td>Optionale Konfiguration per Umgebungsvariablen (keine Secrets). Wird von <code>run.sh</code> geladen.</td>
      </tr>
      <tr>
        <td><code>.venv/</code> (wird erzeugt)</td>
        <td>Virtuelle Python-Umgebung.</td>
      </tr>
      <tr>
        <td><code>.ollama_serve.log</code> (optional)</td>
        <td>Logfile, falls <code>run.sh</code> <code>ollama serve</code> im Hintergrund startet.</td>
      </tr>
    </tbody>
  </table>

  <h2 id="voraussetzungen">Voraussetzungen</h2>
  <ul>
    <li><b>Betriebssystem:</b> Linux, macOS oder Windows. Unter Linux/macOS werden die <code>.sh</code>-Skripte genutzt, unter Windows die mitgelieferten <code>.ps1</code>-Skripte (PowerShell).</li>
    <li><b>Python 3</b> inklusive <code>venv</code> (für <code>python -m venv</code>).</li>
    <li><b>Netzwerkzugriff</b> auf IMAP/SMTP-Server.</li>
    <li><b>Ollama</b> lokal erreichbar (Default: <code>http://localhost:11434</code>).</li>
  </ul>

  <h2 id="konfiguration">Konfiguration</h2>

  <h3>Interaktive Parameter (bei jedem Lauf)</h3>
  <p>
    Beim Start fragt das Programm alle wichtigen Parameter ab (Return nutzt jeweils den Default):
    IMAP/SMTP-Server und Ports, Mailbox, Username, From/Recipient, Name, Zeitraum in Tagen zurück (0=heute, 2=heute plus letzte 2 Tage), Modell und Ollama-URL.
    Das Passwort wird per <code>getpass</code> abgefragt (ohne Anzeige).
  </p>

  <h3><code>.env</code> und Umgebungsvariablen</h3>
  <p><code>bootstrap.sh</code> erzeugt bei Bedarf eine <code>.env</code> mit sinnvollen Defaults. Du kannst sie anpassen.</p>

  <table>
    <thead>
      <tr><th>Variable</th><th>Wirkung</th><th>Beispiel</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><code>OLLAMA_URL</code></td>
        <td>Endpunkt für Ollama. Default ist <code>http://localhost:11434/api/generate</code>.</td>
        <td><code>OLLAMA_URL=http://localhost:11434/api/generate</code></td>
      </tr>
      <tr>
        <td><code>EMAIL_REPORT_LOGLEVEL</code></td>
        <td>Logging-Level (<code>INFO</code> oder <code>DEBUG</code>).</td>
        <td><code>EMAIL_REPORT_LOGLEVEL=DEBUG</code></td>
      </tr>
      <tr>
        <td><code>EMAIL_REPORT_DEBUG</code></td>
        <td>Wenn aktiviert, bleiben Report-Dateien nach Versand erhalten.</td>
        <td><code>EMAIL_REPORT_DEBUG=1</code></td>
      </tr>
      <tr>
        <td><code>EMAIL_REPORT_HTML_PRE</code></td>
        <td>Wenn aktiviert, wird statt der Kartenansicht ein einfacher <code>&lt;pre&gt;</code>-Block verwendet.</td>
        <td><code>EMAIL_REPORT_HTML_PRE=1</code></td>
      </tr>
    </tbody>
  </table>

  <h2 id="ausgabe">Ausgabe und Dateien</h2>
  <p>Während der Verarbeitung entstehen (je nach Debug-Flag) temporäre Dateien im aktuellen Verzeichnis:</p>
  <ul>
    <li><code>zusammenfassung_YYYY-MM-DD_bis_YYYY-MM-DD.txt</code> (Rohsummaries)</li>
    <li><code>zusammenfassung-sortiert_YYYY-MM-DD_bis_YYYY-MM-DD.txt</code> (nach Priorität sortiert)</li>
  </ul>
  <p>Nach erfolgreichem Versand werden diese Dateien standardmäßig gelöscht. Mit <code>EMAIL_REPORT_DEBUG=1</code> bleiben sie erhalten.</p>

  <h2 id="troubleshooting">Troubleshooting</h2>
  <h3>1) Python nicht gefunden</h3>
  <p>Prüfe:</p>
  <pre><code>python3 --version
python --version</code></pre>

  
  <h3>Windows: PowerShell-Skripte oder manuell</h3>
  <p>
    Nutze die mitgelieferten <code>bootstrap.ps1</code> und <code>run.ps1</code> (siehe <a href="#schnellstart">Schnellstart</a>).
    Falls die Skript-Ausführung durch Policies blockiert ist:
  </p>
  <pre><code>Set-ExecutionPolicy -Scope CurrentUser RemoteSigned</code></pre>
  <p>Falls du gar keine Skripte nutzen möchtest, geht es auch manuell:</p>
  <pre><code>python -m venv .venv
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
$env:OLLAMA_URL="http://localhost:11434/api/generate"   # optional, falls Ollama woanders läuft
.\.venv\Scripts\python.exe email_report.py</code></pre>

<h3>2) <code>.venv</code> fehlt</h3>
  <p>Dann wurde <code>bootstrap.sh</code> nicht ausgeführt oder es gab einen Fehler:</p>
  <pre><code>./bootstrap.sh</code></pre>

  <h3>3) Ollama nicht erreichbar</h3>
  <ul>
    <li>Ist Ollama gestartet?</li>
    <li>Stimmt <code>OLLAMA_URL</code>?</li>
    <li>Wenn du ein anderes Host/Port nutzt, trage es in <code>.env</code> ein.</li>
  </ul>

  <h3>4) IMAP/SMTP Login schlägt fehl</h3>
  <ul>
    <li>Username/Passwort korrekt?</li>
    <li>IMAP/SMTP-Server, Port und TLS/SSL korrekt?</li>
    <li>Manche SMTP-Server erlauben nur bestimmte Absender (From) zum Login.</li>
  </ul>

  <h3>5) Keine Mails gefunden</h3>
  <ul>
    <li>Mailbox/Folder prüfen (z.B. <code>INBOX</code>).</li>
    <li>Prüfe den Parameter "Zeitraum in Tagen zurück" (0 = heute, 2 = heute plus letzte 2 Tage).</li>
    <li>Der IMAP-Datumsfilter kann sich je nach Server unterscheiden (SENTDATE vs INTERNALDATE).</li>
  </ul>

  <h2 id="sicherheit">Sicherheit und Datenschutz</h2>
  <ul>
    <li>Das Passwort wird beim Lauf abgefragt und nicht in <code>.env</code> gespeichert.</li>
    <li>Report-Dateien können sensible Inhalte enthalten. Mit <code>EMAIL_REPORT_DEBUG=1</code> bleiben sie liegen: nur nutzen, wenn das ok ist.</li>
    <li>LLM-Ausgaben sind automatisch generiert: bei Unklarheiten immer die Original-Mail öffnen.</li>
  </ul>

  <hr>
  <p class="small">
    Stand: dieses Verzeichnis. Bei Anpassungen am Code diese Anleitung bitte mitpflegen.
  </p>
</body>
</html>
